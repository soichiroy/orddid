% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/orddid-semiparametric-step1.r
\name{ord_two_stage_fit}
\alias{ord_two_stage_fit}
\title{Two-Stage Semiparametric Estimation for Ordered Response Models}
\usage{
ord_two_stage_fit(
  Y,
  X,
  fixed_index = 1,
  w = NULL,
  beta_init = NULL,
  method = c("spectral", "BB"),
  verbose = TRUE
)
}
\arguments{
\item{Y}{Numeric vector of ordered responses (must have exactly 3 categories).
Will be recoded internally to 1, 2, 3 based on sorted unique values.}

\item{X}{Numeric matrix of covariates (n x K). Must include a constant/intercept
column if desired (not added automatically).}

\item{fixed_index}{Integer indicating which coefficient to normalize to 1 for
identification. Default is 1 (typically the intercept). This coefficient will
be fixed at 1 in the estimation.}

\item{w}{Optional numeric vector of observation weights (length n). If NULL,
all observations are weighted equally.}

\item{beta_init}{Optional numeric vector of initial values for beta (length K).
If NULL, initialized via ordered probit MLE (with OLS fallback).}

\item{method}{Character string specifying the solver: "spectral" (default) uses
spectral gradient with Barzilai-Borwein step and backtracking line search;
"BB" uses BB::dfsane if the BB package is available.}

\item{verbose}{Logical. If TRUE, prints iteration progress and convergence info.}
}
\value{
A list with components:
\describe{
  \item{beta}{Numeric vector (length K) of estimated index coefficients with
    beta[fixed_index] = 1.}
  \item{alpha}{Numeric scalar for the estimated threshold parameter separating
    categories 2 and 3.}
  \item{Fhat}{FhatIsotonic object containing the estimated CDF. Has methods
    $predict() and $quantile() for evaluation.}
  \item{index}{Numeric vector (length n) of fitted index values X'beta.}
  \item{predict_probs}{Function closure taking new covariate matrix Xnew and
    returning predicted probabilities (n_new x 3 matrix with columns p1, p2, p3).}
  \item{stage1}{Full output list from stage1ii_solve including convergence info.}
  \item{stage2}{Full output list from EstimateCutoff including bracket and method.}
}
}
\description{
Estimates a 3-category ordered response model using the two-stage semiparametric
method from Yamauchi (2024). Stage 1 solves moment equations to estimate the
index coefficients (beta) and CDF via isotonic regression. Stage 2 estimates
the threshold parameter (alpha) using monotone zero-crossing.
}
\details{
This function implements the complete two-stage estimation procedure:
\itemize{
  \item \strong{Stage 1(i):} Isotonic regression (PAVA) to estimate F(X'beta | beta)
  \item \strong{Stage 1(ii):} Solve moment condition E[X_\{-fixed\} * (1\{Y=1\} - F(X'beta))] = 0
  \item \strong{Stage 2:} Find alpha satisfying E[1 - 1\{Y=3\} - F(X'beta + alpha)] = 0
}

The model assumes: P(Y = j | X) = F(X'beta + alpha_\{j-1\}) - F(X'beta + alpha_\{j-2\})
where alpha_0 = -Inf, alpha_1 = 0 (normalized), alpha_2 = alpha (estimated), alpha_3 = Inf.
}
\examples{
\dontrun{
# Generate 3-category ordered response data
set.seed(123)
n <- 500
X <- cbind(1, rnorm(n), rnorm(n))
beta_true <- c(1, 0.5, -0.3)
alpha_true <- 1.2
latent <- X \%*\% beta_true + rnorm(n)
Y <- cut(latent, breaks = c(-Inf, 0, alpha_true, Inf), labels = FALSE)

# Estimate model
fit <- ord_two_stage_fit(Y, X, verbose = TRUE)

# View results
print(fit$beta)
print(fit$alpha)
print(fit$stage1$converged)
print(fit$stage2$converged)

# Predict probabilities for new data
X_new <- cbind(1, rnorm(10), rnorm(10))
probs <- fit$predict_probs(X_new)
}

}
\references{
Yamauchi, S. (2024). "Simple Semiparametric Estimation of Ordered Response Models."
}
\seealso{
\code{stage1ii_solve}, \code{EstimateCutoff}, \code{stage1i_isotonic}
}
